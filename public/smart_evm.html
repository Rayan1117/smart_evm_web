<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EVM Simulator</title>

<style>
body {
  font-family: Arial, sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  background: #e0e0e0;
}

.evm-box {
  width: 280px;
  height: 460px;
  background: #ffde33;
  border: 4px solid #222;
  border-radius: 6px;
  display: flex;
  flex-direction: column;
  justify-content: space-around;
  padding-left: 40px;
  box-shadow: 4px 4px 8px rgba(0,0,0,0.3);
}

.evm-title {
  font-weight: bold;
  font-size: 24px;
  margin-left: 10px;
}

.row {
  display: flex;
  align-items: center;
  gap: 40px;
}

.button-dot {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #111;
  cursor: pointer;
}

.button-dot.disabled {
  background: #777;
  cursor: not-allowed;
}

.led-dot {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #bbb;
  border: 1px solid #999;
}

.led-dot.on {
  background: limegreen;
  box-shadow: 0 0 8px 2px limegreen;
}

.status {
  position: absolute;
  bottom: 20px;
  font-weight: bold;
}
</style>
</head>

<body>

<div class="evm-box" id="evmBox">
  <div class="evm-title">EVM</div>
</div>

<div class="status" id="statusText">Connecting...</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
/* ---------------- CONFIG ---------------- */
const NUM_PINS = 8;
const espId = "NVEM1234";

/* ---------------- DOM ---------------- */
const evmBox = document.getElementById("evmBox");
const statusText = document.getElementById("statusText");

/* ---------------- STATE ---------------- */
let leds = [];
let buttons = [];
let currentPins = Array(NUM_PINS).fill(0);
let group_pins = [];
let group_count = 0;
let clickedGroups = new Set();

/* ---------------- SOCKET ---------------- */
const socket = io("http://127.0.0.1:5000/", {
  auth: { token: "Bearer " + localStorage.getItem("evm.token") }
});

socket.on("connect", async () => {
  statusText.textContent = "Connected";

  socket.emit("post-connection", { espId, role: "esp" });

  const res = await fetch(
    `http://127.0.0.1:5000/startup/get-config?espId=${espId}`,
    {
      headers: {
        Authorization: "Bearer " + localStorage.getItem("evm.token")
      }
    }
  );

  const { pin_bits, group_pins: gp, cached_votes } = await res.json();

  currentPins = JSON.parse(pin_bits);
  group_pins = JSON.parse(gp);

  buildUI();
  recoverCachedVotes(cached_votes);

  socket.emit("config-changed", currentPins);
  socket.emit("start-election", { espId });
});

socket.on("change-config", data => {
  currentPins = data.pin_bits;
  buildUI();
});

socket.on("check-presence", () => {
  socket.emit("present", { room: espId, role: "esp" });
});

socket.on("vote-updated", resetSelection);

/* ---------------- UI BUILD ---------------- */
function buildUI() {
  evmBox.innerHTML = `<div class="evm-title">EVM</div>`;
  leds = [];
  buttons = [];
  clickedGroups.clear();

  const validGroups = group_pins.filter(g => g !== null);
  group_count = new Set(validGroups).size;
  updateStatus();

  for (let i = 0; i < NUM_PINS; i++) {
    const row = document.createElement("div");
    row.className = "row";

    const btn = document.createElement("div");
    btn.className = "button-dot";

    const led = document.createElement("div");
    led.className = "led-dot";

    leds.push(led);
    buttons.push(btn);

    const groupId = group_pins[i];
    const isDisabled = currentPins[i] === 0 || groupId === null;

    if (isDisabled) {
      btn.classList.add("disabled");
    } else {
      btn.addEventListener("click", () => {
        if (clickedGroups.has(groupId)) return;

        clickedGroups.add(groupId);
        led.classList.add("on");
        updateStatus();

        socket.emit("vote-selected", {
          espId,
          voteIndex: i
        });
      });
    }

    row.appendChild(btn);
    row.appendChild(led);
    evmBox.appendChild(row);
  }
}

/* ---------------- RECOVERY (FAULT TOLERANCE) ---------------- */
function recoverCachedVotes(cachedVotes = []) {
  if (!cachedVotes || !cachedVotes.length) return;

  cachedVotes.forEach(index => {
    const groupId = group_pins[index];
    if (groupId === null) return;

    clickedGroups.add(groupId);
    leds[index]?.classList.add("on");
  });

  updateStatus();
}

/* ---------------- HELPERS ---------------- */
function resetSelection() {
  clickedGroups.clear();
  leds.forEach(led => led.classList.remove("on"));
  updateStatus();
}

function updateStatus() {
  statusText.textContent =
    group_count === 0
      ? "No active voting categories"
      : `Categories voted: ${clickedGroups.size} / ${group_count}`;
}
</script>

</body>
</html>
