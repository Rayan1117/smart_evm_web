<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EVM Simulator</title>

<style>
body {
  font-family: sans-serif;
  padding: 20px;
  background: #f0f0f0;
  text-align: center;
}

h1 { color: #333; }

.evm-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
}

.candidate {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.led {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: #444;
  margin-bottom: 10px;
  transition: background 0.3s;
}

.led.on {
  background: green;
}

.button {
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
}

.button:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.status {
  margin-top: 20px;
  font-weight: bold;
}
</style>
</head>

<body>
<h1>EVM Simulator</h1>
<div class="evm-container" id="evmContainer"></div>
<div class="status" id="statusText"></div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
const NUM_PINS = 8;
const espId = "NVEM1234";

const evmContainer = document.getElementById("evmContainer");
const statusText = document.getElementById("statusText");

let leds = [];
let buttons = [];

let selectedCandidate = -1;
let currentPins = Array(NUM_PINS).fill(0);

let group_pins = [];
let group_count = 0;
let clickedGroups = new Set();
let vote_index = [];

// ---------------- SOCKET ----------------

const socket = io("http://127.0.0.1:5000/", {
  auth: {
    token: "Bearer " + localStorage.getItem("evm.token")
  }
});

socket.on("connect_error", err => console.error("connect_error:", err.message));

socket.on("connect", async () => {
  console.log("âœ… Connected");

  socket.emit("post-connection", { espId, role: "esp" });

  try {
    const res = await fetch(`http://127.0.0.1:5000/startup/get-config?espId=${espId}`, {
      headers: {
        Authorization: "Bearer " + localStorage.getItem("evm.token")
      }
    });

    const { pin_bits, group_pins: gp } = await res.json();

    currentPins = JSON.parse(pin_bits);
    group_pins = JSON.parse(gp);

    buildUI();
    resetSelection();

    socket.emit("config-changed", currentPins);
    socket.emit("start-election", { espId });

  } catch (err) {
    console.error("Startup sync failed:", err.message);
  }
});

socket.on("check-presence", () => {
  socket.emit("present", { room: espId, role: "esp" });
});

socket.on("change-config", data => {
  currentPins = data.pin_bits;
  buildUI();
  resetSelection();

  socket.emit("config-changed", currentPins);
  socket.emit("start-election", { espId });
});

socket.on("vote-updated", resetSelection);
socket.on("reset-selected", resetSelection);

// ---------------- UI BUILD ----------------

function buildUI() {
  evmContainer.innerHTML = "";
  leds = [];
  buttons = [];
  clickedGroups.clear();
  vote_index = [];

  const validGroups = group_pins.filter(g => g !== null);
  group_count = new Set(validGroups).size;

  updateStatus();

  for (let i = 0; i < NUM_PINS; i++) {
    const wrapper = document.createElement("div");
    wrapper.className = "candidate";

    const led = document.createElement("div");
    led.className = "led";
    leds.push(led);

    const btn = document.createElement("button");
    btn.className = "button";
    btn.textContent = `Candidate ${i + 1}`;

    const groupId = group_pins[i];
    const isDisabled = currentPins[i] === 0 || groupId === null;

    btn.disabled = isDisabled;

    if (!isDisabled) {
btn.addEventListener("click", () => {
  if (clickedGroups.has(groupId)) return;

  clickedGroups.add(groupId);

  // Turn LED on
  leds[i].classList.add("on");

  updateStatus();

  // ðŸ”¥ emit for EVERY valid click
  emitVote(i);

  // lock when all groups voted
  if (clickedGroups.size === group_count) {
    selectedCandidate = i;
  }
});

    }

    buttons.push(btn);
    wrapper.appendChild(led);
    wrapper.appendChild(btn);
    evmContainer.appendChild(wrapper);
  }
}

// ---------------- HELPERS ----------------

function emitVote(buttonIndex) {
  console.log("ðŸ—³ï¸ Vote emitted:", espId, buttonIndex);

  socket.emit("vote-selected", {
    espId,
    voteIndex: buttonIndex
  });
}


function resetLEDs() {
  leds.forEach(led => led.classList.remove("on"));
}

function resetSelection() {
  selectedCandidate = -1;
  clickedGroups.clear();
  vote_index = [];
  resetLEDs();
  updateStatus();
}

function updateStatus() {
  if (group_count === 0) {
    statusText.textContent = "No active voting groups";
  } else {
    statusText.textContent = `Groups voted: ${clickedGroups.size} / ${group_count}`;
  }
}
</script>
</body>
</html>
