<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>EVM Simulator</title>

  <style>
    :root {
      --bg: #f0f2f5;
      --box-panel: #facc15;
      --box-panel-alt: #f3c623;
      --box-border: #b59f3b;

      --text-main: #111827;
      --text-muted: #4b5563;
      --primary: #1f2937;
      --accent: #374151;

      --success: #16a34a;

      --button-default: #111111;
      --button-active: #333333;
      --button-disabled: #9ca3af;
      --button-shadow: #000000aa;

      --display-bg: #1e293b;
      --display-text: #f3f4f6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-main);
    }

    .evm-box {
      width: 420px;
      background: linear-gradient(180deg, var(--box-panel), var(--box-panel-alt));
      border: 2px solid var(--box-border);
      border-radius: 18px;
      padding: 26px 24px;
      box-shadow:
        0 12px 28px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .evm-title {
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 20px;
      color: var(--primary);
    }

    .row {
      display: grid;
      grid-template-columns: 36px 28px 1fr;
      align-items: center;
      gap: 14px;
      padding: 10px 0;
    }

    .button-dot {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: var(--button-default);
      cursor: pointer;
      box-shadow: 0 4px 0 var(--button-shadow), 0 4px 6px rgba(0, 0, 0, 0.35);
      transition: all 0.1s ease, background 0.2s ease;
    }

    .button-dot:active:not(.disabled):not(.locked) {
      transform: translateY(2px);
      box-shadow: 0 2px 0 var(--button-shadow), 0 2px 4px rgba(0, 0, 0, 0.35);
    }

    .button-dot.locked {
      opacity: 0.6;
      pointer-events: none;
    }

    .button-dot.disabled {
      background: var(--button-disabled);
      cursor: not-allowed;
      box-shadow: none;
    }

    .button-dot.clicked {
      background: var(--button-active);
    }

    .led-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #d1d5db;
      border: 1px solid #9ca3af;
      transition: background 0.2s ease, box-shadow 0.2s ease;
    }

    .led-dot.on {
      background: var(--success);
      box-shadow: 0 0 8px rgba(22, 163, 74, 0.4);
      border-color: var(--success);
    }

    .label-container {
      display: flex;
      flex-direction: column;
      background: var(--display-bg);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .candidate-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--display-text);
    }

    .category-name {
      font-size: 12px;
      color: #cbd5e1;
    }

    .status {
      margin-top: 16px;
      font-size: 14px;
      color: var(--accent);
      font-weight: 500;
    }

    .category-summary {
      margin-top: 24px;
      width: 420px;
      background: linear-gradient(180deg, #f8fafc, #f1f5f9);
      border: 1px solid #d1d5db;
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .category-summary h3 {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 12px 0;
      color: var(--primary);
    }

    .category-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .category-row:last-child {
      border-bottom: none;
    }
  </style>

</head>

<body>

  <div class="evm-box" id="evmBox">
    <div class="evm-title">Electronic Voting Machine</div>
  </div>

  <div class="status" id="statusText">Connectingâ€¦</div>

  <div class="category-summary" id="categorySummary" style="display:none;">
    <h3>Category Votes</h3>
    <div id="categoryList"></div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const NUM_PINS = 8;
    const espId = "NVEM1234";

    const evmBox = document.getElementById("evmBox");
    const statusText = document.getElementById("statusText");
    const categorySummary = document.getElementById("categorySummary");
    const categoryList = document.getElementById("categoryList");

    let leds = [];
    let buttons = [];
    let currentPins = [];
    let group_pins = [];
    let candidateNames = [];
    let group_names_map = {};
    let clickedGroups = new Set();
    let categoryVotes = {};

    const socket = io("https://voting-api-wnlq.onrender.com/", {
      auth: { token: "Bearer " + localStorage.getItem("evm.token") }
    });

    socket.on("connect", async () => {
      setTimeout(() => {
        socket.emit("post-connection", { espId, role: "esp" });
      }, 50);

      const res = await fetch(
        `https://voting-api-wnlq.onrender.com/startup/get-config?espId=${espId}`,
        { headers: { Authorization: "Bearer " + localStorage.getItem("evm.token") } }
      );

      const {
        pin_bits,
        group_pins: gp,
        cached_votes,
        candidate_names,
        group_names
      } = await res.json();

      currentPins = JSON.parse(pin_bits);
      group_pins = JSON.parse(gp);
      candidateNames = JSON.parse(candidate_names || "[]");
      group_names_map = JSON.parse(group_names || "{}");

      buildUI();
      recoverCachedVotes(cached_votes);
      updateCategoryVotes();
      updateStatus();
    });

    socket.on("change-config", data => { currentPins = data.pin_bits; buildUI(); socket.emit("config-changed", data.group_pins); });

    socket.on("reconnect", () => {
      socket.emit("post-connection", { espId, role: "esp" });
    });

    socket.on("vote-updated", () => {
      resetVote();
    });

    socket.on("check-presence", () => {
      socket.emit("present", { room: espId, role: "esp" });
    });

    function buildUI() {
      evmBox.innerHTML = `<div class="evm-title">Electronic Voting Machine</div>`;
      leds = [];
      buttons = [];
      clickedGroups.clear();
      categoryVotes = {};

      let nameIdx = 0;

      for (let i = 0; i < NUM_PINS; i++) {
        const row = document.createElement("div");
        row.className = "row";

        const btn = document.createElement("div");
        btn.className = "button-dot";
        buttons.push(btn);

        const led = document.createElement("div");
        led.className = "led-dot";
        leds.push(led);

        const label = document.createElement("div");
        label.className = "label-container";

        const candidateText =
          currentPins[i] === 1 ? candidateNames[nameIdx++] || "-" : "-";

        const groupId = group_pins[i];
        const categoryText =
          groupId != null ? group_names_map[String(groupId)] : "-";

        label.innerHTML = `
      <div class="candidate-name">${candidateText}</div>
      <div class="category-name">${categoryText}</div>
    `;

        if (currentPins[i] === 0 || groupId == null) {
          btn.classList.add("disabled");
        } else {
          categoryVotes[groupId] ??= 0;

          btn.onclick = () => {
            if (clickedGroups.has(groupId)) return;

            clickedGroups.add(groupId);
            led.classList.add("on");
            categoryVotes[groupId]++;
            lockGroup(groupId);

            updateCategoryVotes();
            updateStatus();

            socket.emit("vote-selected", { espId, voteIndex: i });
          };
        }

        row.append(btn, led, label);
        evmBox.appendChild(row);
      }
    }

    function recoverCachedVotes(cached = []) {
      cached.forEach(i => {
        const groupId = group_pins[i];
        if (groupId == null) return;

        clickedGroups.add(groupId);
        categoryVotes[groupId] = (categoryVotes[groupId] || 0) + 1;
        leds[i]?.classList.add("on");
        lockGroup(groupId);
      });
    }

    function lockGroup(groupId) {
      group_pins.forEach((g, i) => {
        if (g === groupId) buttons[i]?.classList.add("locked");
      });
    }

    function resetVote() {
      clickedGroups.clear();

      Object.keys(categoryVotes).forEach(gid => {
        categoryVotes[gid] = 0;
      });

      buttons.forEach((btn, i) => {
        btn.classList.remove("locked");
        leds[i]?.classList.remove("on");
      });

      updateCategoryVotes();
      updateStatus();
    }

    function updateCategoryVotes() {
      categoryList.innerHTML = "";
      categorySummary.style.display = "block";

      Object.entries(categoryVotes).forEach(([gid, count]) => {
        const row = document.createElement("div");
        row.className = "category-row";
        row.innerHTML = `
      <span>${group_names_map[gid]}</span>
      <strong>${count}</strong>
    `;
        categoryList.appendChild(row);
      });
    }

    function updateStatus() {
      statusText.textContent = `Categories voted: ${clickedGroups.size}`;
    }
  </script>

</body>

</html>